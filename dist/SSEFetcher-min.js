var SSEFetcher=function(){"use strict";return class{constructor(e,t={}){this._messageQueue=[],this._promiseQueue=Promise.resolve(),this._lastId="",this._buffer="",this._eventType="",this._data="",this._lastIdBuffer="",this._aborted=!1,this._headers={},this._url=e,this._withCredentials=!!t.withCredentials,this._reconnectionDelay=t.reconnectionDelay||2e3,this._headers=t.headers||{},this._maintainConnection()}nextMessage(){return this._promiseQueue=this._promiseQueue.then(()=>this._messageQueue.length>0?this._messageQueue.shift():new Promise(e=>{this._pendingPromiseResolve=e}))}_error(e){const t=Promise.reject(e);this._pendingPromiseResolve&&(this._pendingPromiseResolve(t),this._pendingPromiseResolve=void 0),this._promiseQueue=t}async _readNextLine(e){for(;;){const t=/\r?\n/.exec(this._buffer);if(t){const e=this._buffer.slice(0,t.index);return this._buffer=this._buffer.slice(t.index+t[0].length),e}const{done:s,value:i}=await e.read();if(s)throw Error("Connection terminated");const r=this._decoder.decode(i,{stream:!0});this._buffer+=r}}_flush(){if(this._lastId=this._lastIdBuffer,""===this._data)return void(this._eventType="");"\n"===this._data.slice(-1)&&(this._data=this._data.slice(0,-1));const e={data:this._data,type:this._eventType};this._pendingPromiseResolve?(this._pendingPromiseResolve(e),this._pendingPromiseResolve=void 0):this._messageQueue.push(e),this._data="",this._eventType=""}_process(e,t){switch(e){case"event":this._eventType=t;break;case"data":this._data+=t+"\n";break;case"id":this._lastIdBuffer=t;break;case"retry":const s=Number(t);s&&(this._reconnectionDelay=s)}}async _maintainConnection(){try{await this._connect()}catch(e){await new Promise(e=>setTimeout(e,this._reconnectionDelay)),this._maintainConnection()}}async _connect(){let e={};e="function"==typeof this._headers?this._headers():this._headers;const t=new Headers(e);t.set("Accept","text/event-stream"),this._lastId&&t.set("Last-Event-ID",this._lastId);let s=!1;const i=await fetch(this._url,{headers:t,credentials:this._withCredentials?"include":"same-origin",cache:"no-store"}).catch(e=>{s=e});if(s||!i)return void this._error(Error("0"));if(200!==i.status)return this._error(Error(i.status.toString())),void i.body.cancel();const r=i.headers.get("content-type");if(!r||"text/event-stream"!==r.split(";")[0])return this._error(Error("Bad content-type")),void i.body.cancel();const n=i.body.getReader();for(this._decoder=new TextDecoder,this._buffer="",this._eventType="",this._data="",this._lastIdBuffer="";;){if(this._aborted)return void n.cancel();const e=await this._readNextLine(n);if(""===e)this._flush();else if(":"===e[0]);else if(e.includes(":")){const t=e.indexOf(":"),s=e.slice(0,t);let i=e.slice(t+1);" "===i[0]&&(i=i.slice(1)),this._process(s,i)}else this._process(e,"")}}close(){this._aborted=!0,this._error(new DOMException("","AbortError"))}}}();
